# ğŸ™ï¸ Voz Urbana API

[![Node.js](https://img.shields.io/badge/Node.js-18+-green.svg)](https://nodejs.org/)
[![MySQL](https://img.shields.io/badge/MySQL-8.0-blue.svg)](https://www.mysql.com/)
[![Express.js](https://img.shields.io/badge/Express.js-4.18-black.svg)](https://expressjs.com/)
[![Python](https://img.shields.io/badge/Python-3.8+-yellow.svg)](https://www.python.org/)
[![License](https://img.shields.io/badge/License-MIT-orange.svg)](LICENSE)

Una plataforma integral para la gestiÃ³n de reportes ciudadanos con capacidades de anÃ¡lisis inteligente y detecciÃ³n automÃ¡tica de zonas crÃ­ticas mediante aprendizaje automÃ¡tico.

## ğŸ“‹ Ãndice

- [CaracterÃ­sticas principales](#-caracterÃ­sticas-principales)
- [TecnologÃ­as](#-tecnologÃ­as)
- [InstalaciÃ³n](#-instalaciÃ³n)
- [ConfiguraciÃ³n](#-configuraciÃ³n)
- [Uso](#-uso)
- [API Endpoints](#-api-endpoints)
- [Modelo de Machine Learning](#-modelo-de-machine-learning)
- [Seeders y Datos de Prueba](#-seeders-y-datos-de-prueba)
- [WebSockets](#-websockets)
- [Estructura del Proyecto](#-estructura-del-proyecto)
- [ContribuciÃ³n](#-contribuciÃ³n)
- [Licencia](#-licencia)

## ğŸš€ CaracterÃ­sticas principales

### ğŸ¯ GestiÃ³n de Reportes
- âœ… **CreaciÃ³n de reportes** con geolocalizaciÃ³n, categorÃ­as y prioridades
- âœ… **Sistema de estados** (nuevo, en proceso, resuelto, cerrado, no aprobado)
- âœ… **Carga de imÃ¡genes** con optimizaciÃ³n automÃ¡tica
- âœ… **Sistema de comentarios** con interacciÃ³n ciudadana
- âœ… **VotaciÃ³n de reportes** (upvote/downvote)

### ğŸ¤– Inteligencia Artificial
- âœ… **DetecciÃ³n automÃ¡tica de zonas crÃ­ticas** usando DBSCAN clustering
- âœ… **Modelo hÃ­brido** con predicciones futuras de reportes
- âœ… **ETL automatizado** para procesamiento de datos
- âœ… **GeneraciÃ³n de recomendaciones** basadas en anÃ¡lisis predictivo
- âœ… **VisualizaciÃ³n de patrones** geoespaciales

### ğŸ‘¥ GestiÃ³n de Usuarios
- âœ… **AutenticaciÃ³n JWT** con roles (admin/ciudadano)
- âœ… **Sistema de puntos** por participaciÃ³n ciudadana
- âœ… **Perfiles de usuario** con historial de reportes

### ğŸ“Š Analytics y Reportes
- âœ… **Dashboard administrativo** con mÃ©tricas en tiempo real
- âœ… **GrÃ¡ficos de zonas crÃ­ticas** generados automÃ¡ticamente
- âœ… **EstadÃ­sticas por categorÃ­as** y tendencias temporales
- âœ… **ExportaciÃ³n de datos** en formato CSV

### ğŸ”” Notificaciones en Tiempo Real
- âœ… **WebSockets** para notificaciones instantÃ¡neas
- âœ… **Actualizaciones de estado** de reportes
- âœ… **Alertas de nuevos reportes** por zona

## ğŸ› ï¸ TecnologÃ­as

### Backend
- **Node.js** - Runtime de JavaScript
- **Express.js** - Framework web
- **MySQL** - Base de datos relacional
- **Sequelize** - ORM para Node.js
- **JWT** - AutenticaciÃ³n y autorizaciÃ³n
- **Multer** - Manejo de archivos
- **WebSocket** - ComunicaciÃ³n en tiempo real

### Machine Learning
- **Python 3.8+** - Lenguaje para ML
- **scikit-learn** - Algoritmos de aprendizaje automÃ¡tico
- **DBSCAN** - Clustering para zonas crÃ­ticas
- **Random Forest** - Modelo predictivo
- **matplotlib/seaborn** - VisualizaciÃ³n de datos
- **pandas/numpy** - Procesamiento de datos

### DocumentaciÃ³n
- **Swagger/OpenAPI 3.0** - DocumentaciÃ³n interactiva de la API

## ğŸ“¦ InstalaciÃ³n

### Prerrequisitos
```bash
# Node.js 18+
node --version

# Python 3.8+
python --version

# MySQL 8.0+
mysql --version
```

### 1. Clonar el repositorio
```bash
git clone https://github.com/CarlosJ67/Backend-Voz-Urbana.git
cd Backend-Voz-Urbana
```

### 2. Instalar dependencias de Node.js
```bash
npm install
```

### 3. Instalar dependencias de Python
```bash
pip install -r requirements.txt
```

### 4. Configurar la base de datos
```bash
# Crear base de datos MySQL
mysql -u root -p
CREATE DATABASE voz_urbana;
exit
```

## âš™ï¸ ConfiguraciÃ³n

### 1. Variables de entorno
```bash
# Crear archivo .env
cp .env.example .env
```

Configurar las variables en `.env`:
```env
# Base de datos
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=tu_password
DB_NAME=voz_urbana
DB_PORT=3306

# JWT
JWT_SECRET=tu_jwt_secret_muy_seguro

# Puerto del servidor
PORT=3000
```

### 2. ConfiguraciÃ³n de base de datos
El archivo `config/database.js` contiene la configuraciÃ³n de Sequelize:

```javascript
module.exports = {
  host: process.env.DB_HOST || 'localhost',
  user: process.env.DB_USER || 'root',
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME || 'voz_urbana',
  port: process.env.DB_PORT || 3306
};
```

## ğŸš€ Uso

### 1. Iniciar el servidor
```bash
npm start
```

El servidor estarÃ¡ disponible en:
- **API REST**: `http://localhost:3000`
- **WebSocket**: `ws://localhost:3000/ws`
- **DocumentaciÃ³n**: `http://localhost:3000/api-docs`

### 2. InicializaciÃ³n automÃ¡tica
El sistema inicializa automÃ¡ticamente:
- âœ… Tablas de la base de datos
- âœ… CategorÃ­as predefinidas (9 categorÃ­as)
- âœ… Usuario administrador por defecto

**Credenciales de admin por defecto:**
- Email: `admin@vozUrbana.com`
- Password: `12345678`

## ğŸ“¡ API Endpoints

### ğŸ” AutenticaciÃ³n
```http
POST /api/auth/register     # Registro de usuario
POST /api/auth/login        # Inicio de sesiÃ³n
```

### ğŸ“‹ Reportes
```http
GET    /api/reports                    # Obtener todos los reportes
POST   /api/reports                    # Crear nuevo reporte
GET    /api/reports/:id                # Obtener reporte por ID
PATCH  /api/reports/:id                # Actualizar reporte
DELETE /api/reports/:id                # Eliminar reporte
GET    /api/reports/user/:userId       # Reportes por usuario
GET    /api/reports/location/:lat/:lng/:radius  # Reportes por ubicaciÃ³n
PATCH  /api/reports/admin/status/:id   # Cambiar estado (admin)
```

### ğŸ·ï¸ CategorÃ­as
```http
GET    /api/categorias        # Obtener categorÃ­as
POST   /api/categorias        # Crear categorÃ­a (admin)
PATCH  /api/categorias/:id    # Actualizar categorÃ­a (admin)
DELETE /api/categorias/:id    # Eliminar categorÃ­a (admin)
```

### ğŸ’¬ Comentarios
```http
GET    /api/comentarios/:reporte_id    # Comentarios por reporte
POST   /api/comentarios                # Crear comentario
PATCH  /api/comentarios/:id            # Actualizar comentario
DELETE /api/comentarios/:id            # Eliminar comentario
```

### ğŸ‘ VotaciÃ³n
```http
POST   /api/votos/up          # Voto positivo
POST   /api/votos/down        # Voto negativo
GET    /api/votos/:reporte_id # Obtener votos de reporte
```

### ğŸ› ï¸ Utilidades (Testing)
```http
POST   /api/utils/generar-usuarios-lote      # Generar usuarios de prueba
POST   /api/utils/generar-reportes-lote      # Generar reportes de prueba
POST   /api/utils/generar-comentarios-lote   # Generar comentarios de prueba
POST   /api/utils/ejecutar-etl-reportes      # Ejecutar ETL y modelo ML
```

## ğŸ¤– Modelo de Machine Learning

### Algoritmo Principal: DBSCAN
El sistema utiliza **DBSCAN (Density-Based Spatial Clustering)** para detectar automÃ¡ticamente zonas crÃ­ticas:

```python
# Archivo: seeders/aprendizaje_no_supervisado.py
from sklearn.cluster import DBSCAN

# ConfiguraciÃ³n optimizada
dbscan = DBSCAN(
    eps=0.008,           # Radio de bÃºsqueda
    min_samples=3,       # MÃ­nimo de reportes por cluster
    metric='euclidean'   # MÃ©trica de distancia
)
```

### CaracterÃ­sticas del Modelo
- **ğŸ¯ No supervisado**: No requiere zonas predefinidas
- **ğŸ“ Geoespacial**: Analiza coordenadas lat/lng
- **âš¡ AutomÃ¡tico**: Detecta nÃºmero Ã³ptimo de clusters
- **ğŸ”„ Adaptativo**: Se ajusta a nuevos datos

### Modelo HÃ­brido Predictivo
Adicionalmente incluye predicciones futuras usando **Random Forest**:

```python
# PredicciÃ³n de reportes por zona
from sklearn.ensemble import RandomForestRegressor

# CaracterÃ­sticas: temporales, geogrÃ¡ficas, categÃ³ricas
# PredicciÃ³n: cantidad de reportes esperados
```

### EjecuciÃ³n del Modelo
```bash
# ETL + Modelo automÃ¡tico
curl -X POST http://localhost:3000/api/utils/ejecutar-etl-reportes

# Manual con archivo especÃ­fico
python seeders/aprendizaje_no_supervisado.py ruta/archivo.csv
```

### Salidas del Modelo
- **ğŸ“Š GrÃ¡fico**: `graficos/zonas_criticas_*.png`
- **ğŸ’¾ Modelo**: `modelos/zonas_criticas_*.joblib`
- **ğŸ“ˆ MÃ©tricas**: Silhouette score, nÃºmero de clusters, RÂ²
- **ğŸ”® Predicciones**: Reportes futuros por zona (7 semanas)

## ğŸŒ± Seeders y Datos de Prueba

### GeneraciÃ³n Inteligente de Datos
El sistema incluye seeders avanzados que generan datos realistas para entrenar el modelo:

#### ğŸ‘¥ Usuarios
```bash
# Generar usuarios de prueba
python seeders/seeder_usuarios.py [admins] [ciudadanos] [offset]

# Ejemplo: 5 admins + 10,000 ciudadanos
python seeders/seeder_usuarios.py 5 10000 0
```

#### ğŸ“‹ Reportes Inteligentes
```bash
# Generar reportes con patrones realistas
python seeders/seeder_reportes.py [total] [offset] [fecha_inicio] [fecha_fin]

# Ejemplo: 100,000 reportes del Ãºltimo aÃ±o
python seeders/seeder_reportes.py 100000 0 "2024-01-01" "2024-12-31"
```

**CaracterÃ­sticas de los reportes generados:**
- ğŸ¯ **Clustering natural**: 85% cerca de puntos de interÃ©s
- ğŸ“Š **Prioridades contextuales**: MÃ¡s alta prioridad en zonas densas
- ğŸ• **Patrones temporales**: MÃ¡s reportes en horarios laborales
- ğŸ·ï¸ **CategorÃ­as realistas**: DistribuciÃ³n inteligente por contexto

#### ğŸ’¬ Comentarios
```bash
# Generar comentarios contextual
python seeders/seeder_comentarios.py [total] [offset]
```

### Datos GeogrÃ¡ficos Reales
Los seeders utilizan datos reales de **Xicotepec de JuÃ¡rez, Puebla**:
- âœ… 38 colonias oficiales (INEGI 2023)
- âœ… 120+ calles verificadas (OpenStreetMap)
- âœ… 20 puntos de referencia reales
- âœ… Coordenadas GPS precisas

## ğŸ”” WebSockets

### ConexiÃ³n
```javascript
const ws = new WebSocket('ws://localhost:3000/ws');

ws.onopen = () => {
    console.log('Conectado a Voz Urbana');
    // Suscribirse a notificaciones
    ws.send(JSON.stringify({ type: 'subscribe' }));
};

ws.onmessage = (event) => {
    const notification = JSON.parse(event.data);
    console.log('NotificaciÃ³n:', notification);
};
```

### Tipos de Notificaciones
```javascript
// Nuevo reporte
{
    type: 'new_report',
    data: {
        reportId: 123,
        titulo: 'Bache en Av. JuÃ¡rez',
        prioridad: 'alta',
        usuario: 'Juan PÃ©rez'
    }
}

// Cambio de estado
{
    type: 'status_change',
    data: {
        reportId: 123,
        oldStatus: 'nuevo',
        newStatus: 'en_proceso'
    }
}

// Reportes pendientes
{
    type: 'pending_reports',
    data: {
        count: 15,
        message: 'Tienes 15 reportes pendientes'
    }
}
```

## ğŸ“ Estructura del Proyecto

```
voz-urbana-api/
â”œâ”€â”€ ğŸ“„ server.js                    # Servidor principal
â”œâ”€â”€ ğŸ“„ websocket.js                 # ConfiguraciÃ³n WebSocket
â”œâ”€â”€ ğŸ“„ swagger.js                   # DocumentaciÃ³n API
â”œâ”€â”€ ğŸ“„ package.json                 # Dependencias Node.js
â”œâ”€â”€ ğŸ“„ requirements.txt             # Dependencias Python
â”œâ”€â”€ ğŸ“„ README.md                    # Este archivo
â”œâ”€â”€ ğŸ“ config/                      # ConfiguraciÃ³n
â”‚   â”œâ”€â”€ database.js                 # ConexiÃ³n MySQL
â”‚   â”œâ”€â”€ initDatabase.js             # InicializaciÃ³n DB
â”‚   â””â”€â”€ jwt.js                      # ConfiguraciÃ³n JWT
â”œâ”€â”€ ğŸ“ controllers/                 # LÃ³gica de negocio
â”‚   â”œâ”€â”€ authController.js           # AutenticaciÃ³n
â”‚   â”œâ”€â”€ reportsController.js        # Reportes
â”‚   â”œâ”€â”€ CategoriasController.js     # CategorÃ­as
â”‚   â”œâ”€â”€ comentarioController.js     # Comentarios
â”‚   â”œâ”€â”€ votosController.js          # Sistema de votos
â”‚   â””â”€â”€ utils*Controller.js         # Utilidades/Seeders
â”œâ”€â”€ ğŸ“ middleware/                  # Middleware Express
â”‚   â”œâ”€â”€ auth.js                     # AutenticaciÃ³n JWT
â”‚   â”œâ”€â”€ isAdmin.js                  # VerificaciÃ³n admin
â”‚   â””â”€â”€ upload.js                   # Carga de archivos
â”œâ”€â”€ ğŸ“ models/                      # Modelos Sequelize
â”‚   â”œâ”€â”€ index.js                    # ConfiguraciÃ³n modelos
â”‚   â”œâ”€â”€ User.js                     # Modelo Usuario
â”‚   â”œâ”€â”€ Report.js                   # Modelo Reporte
â”‚   â”œâ”€â”€ Categoria.js                # Modelo CategorÃ­a
â”‚   â”œâ”€â”€ Comentario.js               # Modelo Comentario
â”‚   â””â”€â”€ Voto.js                     # Modelo Voto
â”œâ”€â”€ ğŸ“ routes/                      # Rutas API
â”‚   â”œâ”€â”€ auth.js                     # Rutas autenticaciÃ³n
â”‚   â”œâ”€â”€ reports.js                  # Rutas reportes
â”‚   â”œâ”€â”€ categorias.js               # Rutas categorÃ­as
â”‚   â”œâ”€â”€ comentarios.js              # Rutas comentarios
â”‚   â”œâ”€â”€ votos.js                    # Rutas votaciÃ³n
â”‚   â”œâ”€â”€ utils.js                    # Rutas utilidades
â”‚   â””â”€â”€ test.js                     # Rutas testing
â”œâ”€â”€ ğŸ“ seeders/                     # Datos de prueba y ML
â”‚   â”œâ”€â”€ ğŸ seeder_usuarios.py       # Generador usuarios
â”‚   â”œâ”€â”€ ğŸ seeder_reportes.py       # Generador reportes
â”‚   â”œâ”€â”€ ğŸ seeder_comentarios.py    # Generador comentarios
â”‚   â”œâ”€â”€ ğŸ aprendizaje_no_supervisado.py  # Modelo ML principal
â”‚   â”œâ”€â”€ ğŸ etl_reportes.py          # ETL procesamiento
â”‚   â””â”€â”€ demo-*.js                   # Seeders legacy
â”œâ”€â”€ ğŸ“ uploads/                     # Archivos subidos
â”‚   â””â”€â”€ reports/                    # ImÃ¡genes de reportes
â”œâ”€â”€ ğŸ“ exports/                     # Datos exportados
â”‚   â””â”€â”€ etl_data/                   # CSVs procesados
â”œâ”€â”€ ğŸ“ graficos/                    # Visualizaciones ML
â”‚   â””â”€â”€ zonas_criticas_*.png        # GrÃ¡ficos generados
â”œâ”€â”€ ğŸ“ modelos/                     # Modelos entrenados
â”‚   â””â”€â”€ zonas_criticas_*.joblib     # Modelos guardados
â””â”€â”€ ğŸ“ migrations/                  # Migraciones DB (futuro)
```

## ğŸ”§ Scripts Disponibles

```bash
# Desarrollo
npm start              # Iniciar servidor
npm run dev            # Modo desarrollo (nodemon)

# Base de datos
npm run db:migrate     # Ejecutar migraciones
npm run db:seed        # Ejecutar seeders

# Testing
npm test               # Ejecutar tests
npm run test:watch     # Tests en modo watch

# ProducciÃ³n
npm run build          # Build para producciÃ³n
npm run start:prod     # Iniciar en producciÃ³n
```

## ğŸ¯ Casos de Uso

### ğŸ‘¨â€ğŸ’¼ Para Administradores
1. **Monitoreo de reportes** en tiempo real
2. **GestiÃ³n de estados** y asignaciones
3. **AnÃ¡lisis de zonas crÃ­ticas** automÃ¡tico
4. **ExportaciÃ³n de datos** para informes
5. **Predicciones futuras** para planificaciÃ³n

### ğŸ‘¥ Para Ciudadanos
1. **Reportar problemas** con geolocalizaciÃ³n
2. **Seguimiento de reportes** propios
3. **Comentar y votar** otros reportes
4. **Recibir notificaciones** de actualizaciones
5. **Ganar puntos** por participaciÃ³n

### ğŸ¤– Para Desarrolladores
1. **API REST completa** con documentaciÃ³n
2. **Seeders inteligentes** para testing
3. **Modelo ML integrado** para analytics
4. **WebSockets** para tiempo real
5. **Arquitectura escalable** y modular

## ğŸ“Š MÃ©tricas y Analytics

### Dashboard Disponible
- ğŸ“ˆ **Reportes por estado**: nuevos, en proceso, resueltos
- ğŸ—ºï¸ **Mapa de calor**: zonas con mÃ¡s incidencias
- ğŸ“Š **CategorÃ­as populares**: tipos de problemas mÃ¡s reportados
- â° **Tendencias temporales**: patrones por hora/dÃ­a/semana
- ğŸ¯ **Zonas crÃ­ticas**: clusters detectados automÃ¡ticamente

### MÃ©tricas del Modelo ML
```json
{
  "silhouette_score": 0.742,      // Calidad del clustering
  "n_clusters": 5,                // Zonas crÃ­ticas detectadas
  "cobertura_poblacion": 67.3,    // % reportes en clusters
  "r2_prediccion": 0.845,         // PrecisiÃ³n predicciones
  "mae_prediccion": 2.1           // Error medio absoluto
}
```

## ğŸ”’ Seguridad

### AutenticaciÃ³n
- âœ… **JWT tokens** con expiraciÃ³n configurable
- âœ… **Roles de usuario** (admin/ciudadano)
- âœ… **ValidaciÃ³n de entrada** en todos los endpoints
- âœ… **SanitizaciÃ³n** de datos de usuario

### AutorizaciÃ³n
- âœ… **Middleware de autenticaciÃ³n** en rutas protegidas
- âœ… **VerificaciÃ³n de roles** para operaciones admin
- âœ… **Ownership validation** (usuarios solo pueden editar sus reportes)

### Datos
- âœ… **ValidaciÃ³n de archivos** subidos
- âœ… **LÃ­mites de tamaÃ±o** para uploads
- âœ… **Escape de SQL** vÃ­a Sequelize ORM
- âœ… **EncriptaciÃ³n de passwords** con bcrypt

## ğŸš€ Deployment

### Variables de ProducciÃ³n
```env
NODE_ENV=production
PORT=3000
DB_HOST=tu-servidor-mysql
DB_USER=usuario_prod
DB_PASSWORD=password_seguro
JWT_SECRET=jwt_secret_muy_largo_y_seguro
```

### Docker (Opcional)
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
EXPOSE 3000
CMD ["npm", "start"]
```

### Nginx Reverse Proxy
```nginx
server {
    listen 80;
    server_name tu-dominio.com;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
    
    location /ws {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

## ğŸ¤ ContribuciÃ³n

### Pasos para contribuir
1. **Fork** el repositorio
2. **Crear** una rama para tu feature (`git checkout -b feature/nueva-funcionalidad`)
3. **Commit** tus cambios (`git commit -am 'Agregar nueva funcionalidad'`)
4. **Push** a la rama (`git push origin feature/nueva-funcionalidad`)
5. **Crear** un Pull Request

### EstÃ¡ndares de cÃ³digo
- âœ… **ESLint** para JavaScript
- âœ… **Prettier** para formateo
- âœ… **Conventional Commits** para mensajes
- âœ… **Jest** para testing

### Estructura de commits
```bash
feat: agregar endpoint de estadÃ­sticas
fix: corregir error en validaciÃ³n de coordenadas
docs: actualizar documentaciÃ³n API
test: agregar tests para modelo ML
```

## ğŸ“„ Licencia

Este proyecto estÃ¡ bajo la Licencia MIT - ver el archivo LICENSE para detalles.

## ğŸ™ Agradecimientos

- **INEGI** por los datos geogrÃ¡ficos de Xicotepec
- **OpenStreetMap** por la cartografÃ­a colaborativa
- **scikit-learn** por los algoritmos de ML
- **Express.js** por el framework web
- **MySQL** por la base de datos robusta

## ğŸ“ Contacto

- **Desarrollador**: Carlos J.
- **GitHub**: [@CarlosJ67](https://github.com/CarlosJ67)
- **Repositorio**: [Backend-Voz-Urbana](https://github.com/CarlosJ67/Backend-Voz-Urbana)

---

<div align="center">

**â­ Si este proyecto te resultÃ³ Ãºtil, considera darle una estrella**

Desarrollado con â¤ï¸ para mejorar las ciudades mediante la participaciÃ³n ciudadana

</div>